---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Administrator.
--- DateTime: 2019/9/19 15:38
---
Operation = Operation or {};

function Operation:OpenBloodCycleLayer()
    core.require("xlua/lua_UI/UIOperation/BloodCycleLayer.txt"):new():show();
end

function Operation:SetOperationImage(img,id,path)
    if(img == nil)then
        CS.Logger.LogInfo("img is nil   "..id)
        return;
    end
    if(id == nil)then
        return;
    end
    local _filepath;
    if(path == nil)then
        _filepath = Operation.IMAGE_PATH .. id;
    else
        _filepath = Operation.IMAGE_PATH ..path.."/".. id;
    end
    img:LoadSprite(_filepath);
end

function Operation:SetGiftBagIcon(img,path)
    if(img == nil)then
        CS.Logger.LogInfo("img is nil")
        return;
    end
    if(path == nil)then
        return;
    end
    img:LoadSprite(path);
end

function Operation:NewGiftBagClass(trans,callback)
    local cls = {};
    cls.transform = trans;
    cls.bgCom = trans:Find("img_bg"):GetComponent("Image");
    cls.imgIcon = trans:Find("img_icon"):GetComponent("Image");
    cls.borderCom = trans:Find("img_border"):GetComponent("Image");
    cls.btn = trans:GetComponent("Button");
    cls.data = {};
    if(cls.btn ~= nil)then
        cls.btn.onClick:AddListener(function()
            callback(cls.data);
        end);
    end
    return cls;
end

function Operation:SetGiftBagClass(cls,id)
    local tempData = Recharge:GetData(id);
    if(tempData == nil)then
        CS.Logger.LogError(" Config Error...Operation:SetGiftBagClass: 55");
        return;
    end
    if(cls.imgIcon ~= nil)then
        Operation:SetGiftBagIcon(cls.imgIcon,tempData.icon);
    end
    Bag:SetGoodsBorderByQlty(cls,tempData.qlty);
end


function Operation:GetRechargeStart()
    return Player:GetRechargeStart();
end

function Operation:GetPagingTogRedState()
    return self.leftTogReds;
end

function Operation:GetBottomTogRedState()
    return self.bottomTogReds;
end

function Operation:GetMainLayerBtnRedState()
    --未开启不提示红点
    if not Player:IsSysFuncOpen(Player.SYS_FUNC.sys_benefits) then
        return false
    end
    return self.isRed;
end

function Operation:SetIsSetUpLvRed(isShow)
    if(isShow)then
        Groble_SceneMgr:PrefsSetString(Operation.STR_UP_LV_RED,-1)
    else
        Groble_SceneMgr:PrefsSetString(Operation.STR_UP_LV_RED,1)
    end
end

function Operation:Buy(data,callback,lackBack,showTips)
    local buyNum = 0;
    if(data.priceId == Player.ITEM_VALUE_WITCH_COIN)then
        buyNum = Player:GetMoney();
    elseif(data.priceId == Player.ITEM_VALUE_MONEY)then
        buyNum = Item:GetCount(Player.ITEM_VALUE_MONEY);
    else
        buyNum = Item:GetCount(data.priceId);
    end
    local price = math.ceil(data.price * data.discount);
    if(buyNum < price)then
        Groble_UIMgr:ShowMessageBox(true, true, string.format(LanguageMgr:GetTextByID(90055),
                Item:GetCfg(data.priceId).Name),
                function()
                    if(data.priceId == Player.ITEM_VALUE_WITCH_COIN)then
                        Operation:OpenOperationMainLayer(nil,Operation.ActivityID.WitchCoin,false);
                    elseif(data.priceId == Player.ITEM_VALUE_MONEY)then
                    Operation:OpenOperationMainLayer(nil,Operation.ActivityID.ShopSundryGoods,false);
                    end
                    if(lackBack ~= nil)then
                    lackBack();
                        end
                end)
    else
        if(data.itype == Recharge.ChargeType.PrivilegeGiftPag)then
            core.require("xlua/lua_UI/UIOperation/PrivilegeGiftPagLayer.txt"):new(data.cfgid):show(function()
                if(callback ~= nil)then
                    callback();
                end
            end);
        else
            if(showTips)then
                Groble_UIMgr:ShowMessageBox(true, true,string.format(LanguageMgr:GetTextByID(90057),price,Item:GetCfg(data.priceId).Name) ,
                        function()
                            if(callback ~= nil)then
                                callback();
                            end
                        end)
            else
                if(callback ~= nil)then
                    callback();
                end
            end
        end
    end
end

function Operation:SetTogRedPoint()
    for i = 1, #self.bottomTogReds do
        self.bottomTogReds[i] = false;
    end
    self.isRed = false;
    for itype, v in pairs(self.leftTogReds) do
        self.leftTogReds[itype] = -1;
    end
    for itype, v in pairs(self.leftTogReds) do
        local cfgs = self:GetActiveCfgByUID(itype);
        if(Operation:GetActiveIsOpenByUid(itype))then-- 活动开启才会设置红点
            if(itype == Operation.ActivityID.DailyDeal)then--每日特惠

                local ids = Operation:GetChargeIdsByUID(Operation.ActivityID.DailyDeal);
                local charge,mutualExclusionCfg;
                for _, v in ipairs(ids) do--得到互斥礼包规则配置
                    charge = Recharge:GetData(v);
                    if(charge.price > 0)then
                        mutualExclusionCfg = Operation:GetMutualExclusionCfgByPagId(v);
                        -- break;
                    end
                end
                local isGet = false;
                if(mutualExclusionCfg ~= nil)then
                    local buyState = Operation:GetMutualExclusionGiftPagBuyState(mutualExclusionCfg.id);
                    if(buyState == Operation.MutualExclusionBuyType.Buy)then--购买后,判断是否领取
                        isGet = Operation:GetCurMutualExclusionGetStateById(mutualExclusionCfg.id);
                        if(not isGet)then
                            self.leftTogReds[itype] = 1;
                            self.bottomTogReds[tonumber(cfgs.Interface)] = true;
                            self.isRed = true;
                        end
                    end
                    if(v <= 0 and not isGet)then--判断免费礼包是否领取
                        local tempData,buyNum;
                        local dayGiftData = Operation:GetToDayGiftPagDataById(mutualExclusionCfg.id);--获得今日可领取的免费礼包
                        tempData = Recharge:GetData(dayGiftData.free_id);
                        buyNum = Operation:GetGiftBagBoughtNum(dayGiftData.free_id);
                        if(buyNum == nil)then
                            buyNum = 0;
                        end
                        if (buyNum ~= tempData.stock)then
                            self.leftTogReds[itype] = 1;
                            self.bottomTogReds[tonumber(cfgs.Interface)] = true;
                            self.isRed = true;
                            -- break;
                        end
                    end
                end
            --[[elseif(itype == Operation.ActivityID.BloodCycle or itype)then--血之轮回
                if(self.bottomTogReds[tonumber(cfgs.Interface)] == false)then
                    self.bottomTogReds[tonumber(cfgs.Interface)] = Operation:GetBloodCycleRed(itype);
                end
            --[[elseif(itype == Operation.ActivityID.TimeLimitGift)then -- 限时礼包
                if(v == -1)then
                    if(self._timeLimitRed)then
                        self.leftTogReds[itype] = 1;
                        self.bottomTogReds[tonumber(cfgs.Interface)] = true;
                        self.isRed = true;
                    end
                end]]--
            elseif itype == Operation.ActivityID.WeekCard then -- 萌新好礼
                local ids = self:GetChargeIdsByUID(Operation.ActivityID.WeekCard)
                local isSellOut = false
                for i, cfgId in ipairs(ids) do
                    local _config = Recharge:GetData(cfgId)
                    if _config.price <= 0 then -- 免费
                        local buyNum = self:GetGiftBagBoughtNum(cfgId)
                        if _config.buytype ~= Recharge.BuyType.Normal then
                            isSellOut = isSellOut or (_config.stock - buyNum <= 0)
                        else
                            if _config.stock <= 0 then
                                isSellOut = isSellOut or false
                            else
                                isSellOut = isSellOut or (_config.stock - buyNum <= 0)
                            end
                        end
                    end
                end
                if not isSellOut then
                    self.isRed = true
                    self.leftTogReds[itype] = 1
                    self.bottomTogReds[tonumber(cfgs.Interface)] = true
                end
            end
        end
    end
end

function Operation:GetWitchBookRedStateById(id)
    local bagId = Operation:GetGiftBagBoughtNum(id);
    local handBook = Operation:GetHandBookById(id);
    local tempData = Operation:GetWitchBookIdsById(id);
    local level = Player:GetLevel();
    for i, data in ipairs(tempData) do
        if level >= data.exp then
            if(bagId > 0)then
                if(handBook.sids[data.id] == nil)then
                    return true
                end
            end
            if(handBook.nids[data.id] == nil)then
                return true
            end
        end
    end
    return false;
end

--血之轮回红点
function Operation:GetBloodCycleRed(uid)
    local cfgs = Operation:GetActiveCfgByUID(uid);
    if not cfgs then return false end
    local bagId = Operation:GetGiftBagBoughtNum(cfgs.charges[1]);
    local handBook = Operation:GetHandBookById(cfgs.charges[1]);
    local tempData = Operation:GetWitchBookIdsById(cfgs.charges[1]);
    local tempExp = Player:GetValue(Player.VALUE_HANDBOOK_EXP);
    for _, data in ipairs(tempData) do
        if(tempExp - data.exp >= 0)then
            tempExp = tempExp - data.exp;
            if(bagId > 0)then
                if(handBook.sids[data.id] == nil)then
                    return true
                end
            end
            if(handBook.nids[data.id] == nil)then
                return true
            end
        end
    end
    return false;
end

function Operation:GetCurCycleIndex(id,lv)
    local tempData = Operation:GetWitchBookIdsById(id);
    local bagId = Operation:GetGiftBagBoughtNum(id);
    local handBook = Operation:GetHandBookById(id);
    local retIndex = lv;
    for i, data in ipairs(tempData) do
        if(lv >= i)then
            if(bagId > 0)then
                if(handBook.sids[data.id] == nil)then
                    retIndex = i;
                    break;
                end
            end
            if(handBook.nids[data.id] == nil and data.freeAward ~= -1)then
                retIndex = i;
                break;
            end
            retIndex = i;
        end
    end
    return retIndex;
end

function Operation:PopUpGiftBagLayer(data,showIndex)
    if(#data > 0)then
        core.require("xlua/lua_UI/UIOperation/PopUpGiftBagLayer.txt"):new():show(data,showIndex);
    end
end

--打开运营活动主界面
function Operation:OpenOperationMainLayer(id,uid,playAnim)
    if(id == nil)then
        local cfg = Operation:GetActiveCfgByUID(uid);
        id = tonumber(cfg.Interface);
    end
    if(self.OperationMainLayer == nil)then
        self.OperationMainLayer = core.require("xlua/lua_UI/UIOperation/OperationMainLayer.txt"):new()
    end
    self.OperationMainLayer:SetInitState(true);
    self.OperationMainLayer:show(id, uid, playAnim);
end

--关闭运营活动主界面
function Operation:CloseOperationMainLayer()
    if(self.OperationMainLayer == nil)then
        return;
    end
    self.OperationMainLayer:onBtnBack();
    self.OperationMainLayer = nil;
end

-- brief：角标统一设置接口
function Operation:SetCursorTag(imgCursor, txtCursor, valueCursor, strCursor)
    imgCursor:SetEnabled(valueCursor > 0)
    if valueCursor > 0 then
        local _strCursor = strCursor
        imgCursor:LoadAtlasSprite(AtlasMgr.Operation, Operation.OPERATION_TAG_ICON[valueCursor])
        imgCursor:SetVisible(true)
        if valueCursor == Operation.OPERATION_TAG_1 then
            _strCursor = LanguageMgr:GetTextByID(90253)
        elseif valueCursor == Operation.OPERATION_TAG_2 then
            _strCursor = LanguageMgr:GetTextByID(90254)
        elseif valueCursor == Operation.OPERATION_TAG_4 then
            _strCursor = LanguageMgr:GetTextByID(90255)
        end
        txtCursor:SetText(_strCursor)
    else
        imgCursor:SetVisible(false)
        txtCursor:SetText("")
    end
end

