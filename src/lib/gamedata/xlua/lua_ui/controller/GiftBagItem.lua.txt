---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Administrator.
--- DateTime: 2019/9/19 19:59
---
local GiftBagItem = class("GiftBagItem");

--初始化
function GiftBagItem:ctor(super, trans)
    self._data = nil;
    self.transform = trans;
    --self.discountBg = trans:Find("discount_bg");
    --self.txtDiscount = trans:Find("text_discount"):GetComponent("Text");
    self.stockBg = trans:Find("stock_bg");
    self.txtStock = trans:Find("text_stock"):GetComponent("Text");
    --self.remainBg = trans:Find("remain_bg");
    self.prefabItem = trans:Find("item_hide/prefab_item");
    self.itemBg = trans:Find("item_bg/view_port/content");
    self.items = {}-- Operation:NewGiftBagClass(trans:Find("prefab_item"));
    self.btnClick = trans:Find("button_click"):GetComponent("Button");
    self.txtCurPrice = trans:Find("text_all_price/text_cur_price"):GetComponent("Text");
    self.textAllPrice = trans:Find("text_all_price"):GetComponent("Text");
    self.redLine = self.textAllPrice.transform:Find("line");
    -- self._txtGet = trans:Find("txt_get"):GetComponent("Text");
    --self.txtName = trans:Find("text_name"):GetComponent("Text");
    --self.imgSellout = trans:Find("image_sellout");
    self.imgRed = trans:Find("img_red");
    self.sellOut = trans:Find("txt_sell_out");
    -- self.objIsBuy = trans:Find("img_is_buy").gameObject;
    self.imgPriceIcon = trans:Find("text_all_price/img_price"):GetComponent("Image");
end


function GiftBagItem:SetData(cfgId,action)
    cfgId = tonumber(cfgId);
    self._data = Recharge:GetData(cfgId);
    local buyNum = Operation:GetGiftBagBoughtNum(cfgId);
    if(buyNum == nil)then
        buyNum = 0;
    end
    set_obj_active(self.transform,true);
    --set_obj_active(self.remainBg,false);
    --self.txtName.text = self._data.name;
    --set_obj_active(self.txtStock,self._data.stock > Recharge.BuyType.Normal);
    --set_obj_active(self.stockBg,self._data.stock > Recharge.BuyType.Normal);
    if(self._data.buytype == Recharge.BuyType.day)then
        self.txtStock:SetTextById(99000081);
    elseif(self._data.buytype == Recharge.BuyType.Week)then
        self.txtStock:SetTextById(99000009);
    elseif(self._data.buytype == Recharge.BuyType.Month)then
        self.txtStock:SetTextById(99000010);
    elseif(self._data.buytype == Recharge.BuyType.Normal)then
        self.txtStock:SetTextById(99000008);
    elseif(self._data.buytype == Recharge.BuyType.IsDoubleWeek)then
        self.txtStock:SetTextById(99000083);
    end
    local giftData
    local num = 0;
    if(self._data.goOngoods ~= -1)then
        giftData = Operation:GetMonthDataById(cfgId);
        num = #self._data.goOngoods;
        for i, v in ipairs(self._data.goOngoods) do
            if(self.items[i] == nil)then
                local cls = Bag:CtorComSimpleGoodsUi(CS.UnityEngine.GameObject.Instantiate(self.prefabItem, self.itemBg));
                cls.txtTitle = cls:GetTextComponent("txt_title");
                self.items[i] = cls;
            end
            Bag:SetComSimpleGoodsUi(self.items[i],v[1],v[2],v[3])
            set_obj_active(self.items[i].checkCom,buyNum == self._data.stock)
            set_obj_active(self.items[i].transform,true);
            self.items[i].txtTitle.text = "";
            self.items[i].txtTitle.text = string.format(LanguageMgr:GetTextByID(90172), giftData.sustainDay);
        end
    end

    for i = 1, #self._data.goods do
        if(self.items[i + num] == nil)then
            local cls = Bag:CtorComSimpleGoodsUi(CS.UnityEngine.GameObject.Instantiate(self.prefabItem, self.itemBg));
            cls.txtTitle = cls:GetTextComponent("txt_title");
            self.items[i + num] = cls;
        end
        Bag:SetComSimpleGoodsUi(self.items[i + num],self._data.goods[i][1],self._data.goods[i][2],self._data.goods[i][3])
        set_obj_active(self.items[i + num].checkCom,buyNum == self._data.stock)
        set_obj_active(self.items[i + num].transform,true);
        -- self.items[i + num].txtTitle.text = "";
    end
    if(#self._data.goods + num < #self.items)then
        for i = #self._data.goods + num + 1, #self.items do
            set_obj_active(self.items[i].transform,false);
        end
    end
    self.txtStock.text = self.txtStock.text..buyNum.. "/".. self._data.stock;
    --set_obj_active(self.imgSellout,buyNum == self._data.stock);
    --Operation:SetGiftBagClass(self.prefabItem,cfgId);
    set_obj_active(self.btnClick.transform,buyNum ~= self._data.stock)
    local btnIsClick = true;
    local showRedTips = true;
    if(buyNum ~= self._data.stock)then
        set_obj_active(self.sellOut,false);
        if(self._data.itype == Recharge.ChargeType.MutualExclusion)then--互斥礼包
            local mutualExclusionData = Operation:GetMutualExclusionServerDataByPagId(cfgId);
            if(mutualExclusionData ~= nil)then--已购买互斥礼包,关闭价格
                showRedTips = false;
                btnIsClick = false;
                -- self.objIsBuy:SetVisible(true);
                set_obj_active(self.textAllPrice.transform,false);
                -- set_com_enabled(self._txtGet,false);
            else
                -- self.objIsBuy:SetVisible(false);
                if(self._data.price <= 0)then--免费
                    -- set_com_enabled(self._txtGet,true);
                    set_obj_active(self.textAllPrice.transform,false);
                else
                    -- set_com_enabled(self._txtGet,false);
                    set_obj_active(self.textAllPrice.transform,true);
                end
            end
        else
            -- self.objIsBuy:SetVisible(false);
            if(self._data.price <= 0)then
                -- set_com_enabled(self._txtGet,true);
                set_obj_active(self.textAllPrice.transform,false);
            else
                -- set_com_enabled(self._txtGet,false);
                set_obj_active(self.textAllPrice.transform,true);
            end
        end
        self.btnClick.gameObject:SetVisible(btnIsClick);
        set_obj_active(self.txtCurPrice.transform,self._data.discount < 1);
        set_obj_active(self.redLine,self._data.discount < 1);
        if(self._data.discount < 1)then
            self.textAllPrice.text = string.format(LanguageMgr:GetTextByID(90053),self._data.price);
            local curPrice = self._data.price * self._data.discount;
            curPrice = math.floor(curPrice);
            self.txtCurPrice.text = curPrice;
        else
            self.textAllPrice.text = string.format(LanguageMgr:GetTextByID(90054),self._data.price);
        end
        self.imgPriceIcon.sprite = Item:LoadSprite(Player.ITEM_VALUE_WITCH_COIN)
    else
        if(self._data.itype == Recharge.ChargeType.MutualExclusion)then--互斥礼包
            local mutualExclusionData = Operation:GetMutualExclusionServerDataByPagId(cfgId);
            if(mutualExclusionData ~= nil)then--已购买互斥礼包,关闭价格
                set_obj_active(self.sellOut,false);
                -- self.objIsBuy:SetVisible(true);
            else
                set_obj_active(self.sellOut,true);
                -- self.objIsBuy:SetVisible(false);
            end
        else
            set_obj_active(self.sellOut,true);
            -- self.objIsBuy:SetVisible(false);
        end
        set_obj_active(self.textAllPrice.transform,false);
        -- set_com_enabled(self._txtGet,false);
    end
    --set_obj_active(self.txtDiscount,self._data.discount < Recharge.DISCOUNT_IS_NIL);
    --set_obj_active(self.discountBg,self._data.discount < Recharge.DISCOUNT_IS_NIL);
    --self.txtDiscount.text = "-" ..math.floor((Recharge.DISCOUNT_IS_NIL - self._data.discount) * 100) .."%";
    set_obj_active(self.imgRed,(self._data.price == 0) and (buyNum ~= self._data.stock) and showRedTips);
    if(action ~= nil)then
        action(self.transform);
    end
end

function GiftBagItem:AddListener(back)
    self.btnClick.onClick:AddListener(function ()
        back(self._data.cfgid);
    end);
end


function GiftBagItem:HideItem()
    set_obj_active(self.transform,false);
end

function GiftBagItem:OnDestroy()

end
return GiftBagItem;