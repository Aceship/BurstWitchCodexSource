---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Administrator.
--- DateTime: 2019/9/18 15:48
--自选礼包界面
local CBaseLayer = core.require("xlua/lua_UI/UIBaseLayer.txt")
local OptionalLayer = class("OptionalLayer", CBaseLayer)
local line_nums = 4;
--按钮
local BTNS = {
    btnGet = "container/button_get",
    btnAdd = "container/slider/button_add",
    btnSub = "container/slider/button_sub",
}
--构造函数
function OptionalLayer:ctor(super)
    CBaseLayer.ctor(self)
    self._prefab = {
        path = "prefab_uiHome/sys/UI_OptionalLayer",
    }
    self._fading = false;
    self._uitype = 2;
    self._name = ""
    self:onEnter()
end


--进入Ui调用一次
function OptionalLayer:onEnter()
    self:createPnl();
    self:registerButtonEvent(BTNS);
    self:Init();
end


--退出按钮事件
function OptionalLayer:onBackClick()
    self:onPopLayer();
end

function OptionalLayer:onButtonClick(itype)
    if(itype == BTNS.btnGet)then
        if self._num > 1 then
            local tips = string.format(LanguageMgr:GetTextByID(1900050), self._name,"\n", self._num)
            Groble_UIMgr:ShowMessageBox(true, true, tips,
                    function()
                        if(self.callback ~= nil)then
                            self.callback(self.cfgId, self._num, self.getIndex);
                        end
                    end)
            self:onBackClick();
        else
            if(self.callback ~= nil)then
                self.callback(self.cfgId, self._num, self.getIndex);
            end
            self:onBackClick();
        end

    elseif itype == BTNS.btnAdd then
        if self._num < self.maxCount then
            self._num = self._num + 1
            self._slider.value = self._slider.value + 1
            self.txtGiftBagName.text = string.format("%s x%d", self.cfg.Name, self._num)
        end
    elseif itype == BTNS.btnSub then
        if self._num > 1 then
            self._num = self._num - 1
            self._slider.value = self._slider.value - 1
            self.txtGiftBagName.text = string.format("%s x%d", self.cfg.Name, self._num)
        end
    end
end

--初始化
function OptionalLayer:Init()
    self.cells = {};
    self._num = 1
    self.isInit = true;
    self.selectImg = self.layer:Get("container/img_select");
    self.txtGiftBagName = self.layer:GetTextComponent("container/title/txt_name")
    self.selectItem = Bag:CtorComSimpleGoodsUi(self.layer:Get("container/select_item"),function()end);
    
    self.infoEquip = {};
    self.infoEquip.transform = self.layer:Get("container/info_equip");
    self.infoEquip.txtName = self.layer:GetTextComponent("container/info_equip/txt_name")
    self.infoHero = {};
    self.infoHero.transform = self.layer:Get("container/info_hero");
    self.infoHero.txtContent = self.layer:GetTextComponent("container/info_hero/txt_content")
    self.infoItem = {}
    self.infoItem.transform = self.layer:Get("container/info_item");
    self.infoItem.txtName = self.layer:GetTextComponent("container/info_item/txt_name")
    self.infoItem.txtContent = self.layer:GetTextComponent("container/info_item/txt_content")
    self.infoItem.txtCount = self.layer:GetTextComponent("container/info_item/txt_count")
end


--显示UI
function OptionalLayer:show(cfgId,callback)
    self:showLayer();
    self.cfgId = cfgId;
    self.callback = callback;
    self.cfg = Item:GetCfg(cfgId);
    self.maxCount = Item:GetCount(cfgId)
    self.itemDatas = lua_parse_cfg(self.cfg.Itemlist,true);
    --self:playAni("CommonLayerFadeInAni");
    self:InitUI();
    self:onItemClick(1)
    self:setSlider()
end

function OptionalLayer:setSlider()
    if tonumber(self.cfg.subType) == Item.SUBTYPE_GIFT_CHOICE and self.maxCount > 1 then
        self.layer:Get("container/slider"):SetVisible(true)
        self._slider = self.layer:GetSliderComponent("container/slider/slider")
        self._slider.value = 1
        self._slider.maxValue = self.maxCount
        self.layer:GetTextComponent("container/slider/text_max").text = self.maxCount
        self._slider.onValueChanged:AddListener(
                function()
                    self._num = self._slider.value
                    self.txtGiftBagName.text = string.format("%s x%d", self.cfg.Name, self._num)
                end)
    else
        self.layer:Get("container/slider"):SetVisible(false)
    end
end

--初始化UI
function OptionalLayer:InitUI()
  
    self.txtGiftBagName.text = string.format("%s x%d", self.cfg.Name, self._num)
    self:InitTableView();
end

--初始化Table View
function OptionalLayer:InitTableView()
    local rows = math.ceil(#self.itemDatas/line_nums);
    self._rows = rows
    if(self._tvController == nil)then
        self._tvController = UIController:CtorTableView(self.layer:Get("container/TableViewController"));
        self._tvController:Init(rows, true,
        function(cell, row, play)
            self:SetData(cell,row+1);
        end, 0.15, 0.075);
    else
        self._tvController:ScrollToTop();
        self._tvController:Reload(rows, false);
    end
end



function OptionalLayer:newCellObj(cell)
    local cls       = clsbase:new(cell)
    cls.itemArr = {}
    for i = 1, line_nums, 1 do
        cls.itemArr[i] =  Bag:CtorComSimpleGoodsUi(cell.transform:Find("item_" .. i),
                function()
                    self:onItemClick((cls.row - 1) * line_nums + i)
                end)
    end
    cls.row = 0
    return cls
end


--设置物品数据
function OptionalLayer:SetData(cell,row)
    
    local cls = self.cells[cell.name]
    if cls == nil then
        cls = self:newCellObj(cell)
        self.cells[cell.name] = cls
    end
    self:refreshCellObj(cls, row)
  
end

function OptionalLayer:refreshCellObj(cls, row)
    local index,data
    for i = 1, line_nums, 1 do
        index = i + (row - 1) * line_nums
        if self.itemDatas[index] ~= nil then
            data = self.itemDatas[index]
            Bag:SetComSimpleGoodsUi(cls.itemArr[i], data[1], data[2], data[3])
            set_com_enabled(cls.itemArr[i].checkCom, self.getIndex == index)
            cls.data = data
        end
        cls.itemArr[i]:Visible(self.itemDatas[index] ~= nil)
    end
    cls.row = row
end

--物品点击事件
function OptionalLayer:onItemClick(i)
   
    self.getItemId =  self.itemDatas[i][2];
    self.getIndex = i;
    local data = self.itemDatas[i]
    for _, cls in pairs(self.cells) do
        for i = 1, line_nums, 1 do
            set_com_enabled(cls.itemArr[i].checkCom, self.getIndex == i + (cls.row - 1) * line_nums)
        end
    end

    if(data[1] == Bag.TYPE_EQUIP)then--装备
        local equip = Equip:GetCfg(data[2]);
        local tempCfg = Equip:InitEquip(data[2]);--初始化装备信息,方便显示
        self.infoEquip.transform:SetVisible(true)
        self.infoHero.transform:SetVisible(false)
        self.infoItem.transform:SetVisible(false)
        Bag:SetComSimpleGoodsUi(self.selectItem,data[1], data[2], data[3], true);
        self:SetEquipInfo(tempCfg);
        self.infoEquip.txtName.text = equip.Name;
        self._name = equip.Name
    elseif data[1] == Bag.TYPE_ITEM then
        self.infoEquip.transform:SetVisible(false)
        self.infoHero.transform:SetVisible(false)
        self.infoItem.transform:SetVisible(true)
        local item = Item:GetCfg(data[2]);
        self.infoItem.txtName.text = item.Name
        self.infoItem.txtContent.text = item.itemInfo
        Bag:SetComSimpleGoodsUi(self.selectItem,data[1], data[2], data[3], true);
        self.infoItem.txtCount.text = Item:GetCount(data[2])
        self._name = item.Name
    else
        --角色
        self.infoEquip.transform:SetVisible(false)
        self.infoHero.transform:SetVisible(true)
        self.infoItem.transform:SetVisible(false)
        local item = Item:GetCfg(data[2]);
        if(tonumber(item.Syntheticprops) == -1)then
            return;
        end
        local hero = Hero:GetCfg(tonumber(item.Syntheticprops));
        Bag:SetComSimpleGoodsUi(self.selectItem,Bag.TYPE_HERO, tonumber(item.Syntheticprops), 1, true);
        if(self.infoBasic == nil)then
            self.infoBasic = Hero:NewHeroBasic(self.infoHero.transform);
        end
        Hero:SetHeroBasic(self.infoBasic,hero,true)
        self.infoHero.txtContent.text = hero.dialog;
        self._name =  self.infoHero.txtName.text
    end
end

--设置装备界面信息
function OptionalLayer:SetEquipInfo(equipdata)
    if self.equipSkill == nil then
        self.equipSkill = Equip:NewPassiveSkill(self.layer:Get("container/info_equip"))
    end
    Equip:SetPassiveSkill(self.equipSkill, equipdata, 0)
    
--[[    local desc = ""
    --符石
    self.infoEquip.rectSkill.sizeDelta = CS.UnityEngine.Vector2(self.infoEquip.rectSkill.sizeDelta.x,130);
    local suitcfgids = Equip:GetEquipSuitCfgIds(equipdata.suitid, Equip.SUIT_MAX_NUM) or {}
    local suitcfg, deskillcfg, tmpdesc
    local suitnum = 0   -- 已达成的数量
    for _, v in pairs(suitcfgids) do
        suitcfg = Equip:GetEquipSuitCfg(v)
        deskillcfg = Skill:GetCfgByTypeIdStr(suitcfg.skill)
        suitnum = lua_math_in_range(suitnum,0,suitcfg.num) or 0;
        tmpdesc = string.format(LanguageMgr:GetTextByID(99000042), suitnum, suitcfg.num, deskillcfg.desc)
        if suitnum < suitcfg.num then
            tmpdesc = string.format(LanguageMgr:GetTextByID(99000043), tmpdesc)
        end
        if desc == nil then
            desc = tmpdesc
        else
            desc = desc .. "\n" .. tmpdesc
        end
    end
    self.infoEquip.txtSkill.text = lua_color_str(desc)]]
end

return OptionalLayer;

