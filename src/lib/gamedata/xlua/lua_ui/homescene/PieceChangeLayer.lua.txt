---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Administrator.
--- DateTime: 2019/9/18 15:48
--碎片转换界面
local CBaseLayer = core.require("xlua/lua_UI/UIBaseLayer.txt")
local PieceChangeLayer = class("PieceChangeLayer", CBaseLayer)
local line_nums = 5 
--按钮
local BTNS = {
    btnOk = "container/show/button_ok",
    btnCancel = "container/show/button_cancel",
    btnBack = "container/notshow/button_ok"
}
--构造函数
function PieceChangeLayer:ctor(super)
    CBaseLayer.ctor(self)
    self._prefab = {
        path = "prefab_uiHome/sys/UI_PieceChangeLayer",
    }
    self._fading = false 
    self._uitype = 2 
    self:onEnter()
end


--进入Ui调用一次
function PieceChangeLayer:onEnter()
    self:createPnl() 
    self:registerButtonEvent(BTNS)
    self:Init() 
end


--退出按钮事件
function PieceChangeLayer:onBackClick()
    self:onPopLayer()
end

function PieceChangeLayer:onButtonClick(itype)
    if(itype == BTNS.btnOk)then
        if self._total == 0 then
            return
        end
        self:sendRequest()
    elseif itype == BTNS.btnCancel then
        self:onBackClick()
    elseif itype == BTNS.btnBack then
        self:onBackClick()
    end
end

--初始化
function PieceChangeLayer:Init()
    self.cells = {}
    self.selectItem = Bag:CtorComSimpleGoodsUi(self.layer:Get("container/show/select_item"))
    self._data,self._total = Hero:GetHeroPieceTbl()
  
    self.layer:GetTextComponent("container/desc/txt_title_r").text = string.format(LanguageMgr:GetTextByID(79000020),  Player.PIECE_SHOP_NUM[1][2])
    self.layer:GetTextComponent("container/desc/txt_title_sr").text = string.format(LanguageMgr:GetTextByID(79000021),  Player.PIECE_SHOP_NUM[2][2])
    self.layer:GetTextComponent("container/desc/txt_title_ssr").text = string.format(LanguageMgr:GetTextByID(79000022),  Player.PIECE_SHOP_NUM[3][2])
    self.layer:Get("container/show"):SetVisible(self._total ~= 0)
    self.layer:Get("container/notshow"):SetVisible(self._total == 0)
end


--显示UI
function PieceChangeLayer:show()
    self:showLayer()
    self:InitUI()
    self:setItemNum()
end

--初始化UI
function PieceChangeLayer:InitUI()
    self:InitTableView()
end

--初始化Table View
function PieceChangeLayer:InitTableView()
    local rows = math.ceil(#self._data/line_nums) 
    self._rows = rows
    if(self._tvController == nil)then
        self._tvController = UIController:CtorTableView(self.layer:Get("container/show/TableViewController"))
        self._tvController:Init(rows, true,
        function(cell, row, play)
            self:SetData(cell,row+1) 
        end, 0.15, 0.075) 
    else
        self._tvController:ScrollToTop() 
        self._tvController:Reload(rows, false) 
    end
end



function PieceChangeLayer:newCellObj(cell)
    local cls       = clsbase:new(cell)
    cls.itemArr = {}
    for i = 1, line_nums, 1 do
        cls.itemArr[i] =  Bag:CtorComSimpleGoodsUi(cell.transform:Find("item_" .. i))
    end
    cls.row = 0
    return cls
end


--设置物品数据
function PieceChangeLayer:SetData(cell,row)
    
    local cls = self.cells[cell.name]
    if cls == nil then
        cls = self:newCellObj(cell)
        self.cells[cell.name] = cls
    end
    self:refreshCellObj(cls, row)
  
end

function PieceChangeLayer:refreshCellObj(cls, row)
    local index,data
    for i = 1, line_nums, 1 do
        index = i + (row - 1) * line_nums
        if self._data[index] ~= nil then
            data = self._data[index]
            Bag:SetComSimpleGoodsUi(cls.itemArr[i], data[1], data[2], data[3])
            cls.data = data
        end
        cls.itemArr[i]:Visible(self._data[index] ~= nil)
    end
    cls.row = row
end


--设置装备界面信息
function PieceChangeLayer:setItemNum()
    Bag:SetComSimpleGoodsUi(self.selectItem ,Bag.TYPE_ITEM ,Player.ITEM_VALUE_PIECE_COIN,self._total)
    if self._total == 0 then
        self.selectItem.numCom.text = 0
        self.selectItem.numCom.gameObject:SetVisible(true)
    end
   
end

function PieceChangeLayer:sendRequest()
    local tbl = {}
    for _, v in pairs(self._data) do
        tbl[v[2]] = v[3]
    end
    Shop:ExChangeChipsReq(tbl)
    self:onBackClick()
end


return PieceChangeLayer 

