---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Administrator.
--- DateTime: 2020/10/22 11:28
---

local CBaseLayer = core.require("xlua/lua_UI/UIBaseLayer.txt")
local EquipSuitLayer = class("EquipSuitLayer", CBaseLayer)

function EquipSuitLayer:ctor(super)
    CBaseLayer.ctor(self)
    self._prefab = {
        path = "prefab_uiEquip/UI_EquipSuitLayer",
    }
    self._topData = {};
    self._addStack = true;
    self._fading = false;
    self:onEnter()
end

function EquipSuitLayer:onBackClick()
    self:onPopLayer();
end

function EquipSuitLayer:initObj()

    self.dataList       = {}
    self._cellsObj      = {}
    self.tvController   = UIController:CtorTableView(self.layer:Get("rt_container/TableViewController"))
    self._rectContent   = self.layer:GetRectTransformComponent("TableView/Content")
    self._rectTv        = self.layer:GetRectTransformComponent("TableView")

    self:addEventListener(EVENT_TYPE.HERO_EQUIP_UI, self.__cname, function()
        -- 装备已自动穿戴
        if self.ondress then
            self.ondress = nil
            UIMgr:ShowTipsLayer(LanguageMgr:GetTextByID(72000081));
            self:onBackClick();
            -- if self.menu then
            --     self.menu.togs[1].tog.isOn = true
            -- end
        end
    end)
end

function EquipSuitLayer:onEnter()

    self:createPnl()
    self:initObj()
end

function EquipSuitLayer:show(heroid, menu)
    self._heorid = heroid
    self.menu = menu
    local hero = Hero:GetHero(self._heorid)
    self.dataList = Equip:GetRecommendcfg(heroid)
    self.tvController:Init(#self.dataList, true, function(cell, row)
        self:refreshCell(cell, row + 1)
    end, 0.3, 0.1)
    
    self:showLayer()
end

function EquipSuitLayer:newCellObj(cell)
    local cls              = clsbase:new(cell)

    cls.txtHave            = {}
    cls.tags               = {}
    cls.imgLight           = {}
    for i = 1, 3 do
        cls.tags[i]        = {}
        cls.tags[i].obj    = cell.transform:Get(string.format("img_tag_%d", i))
        cls.tags[i].img    = cls.tags[i].obj:GetImageComponent("")
        cls.tags[i].txt    = cls.tags[i].obj:GetTextComponent("txt_tag")
        cls.txtHave[i]     = {}
        cls.txtHave[i].obj = cell.transform:Get(string.format("label_have_%d", i))
        cls.txtHave[i].txt = cls.txtHave[i].obj:GetTextComponent("")
        cls.imgLight[i]    = cell.transform:Get(string.format("img_light_%d", i))
    end

    cls.pos = {}
    for i = 1, 6 do
        cls.pos[i]          = {}
        cls.pos[i].cobj     = Equip:CtorEquipCObj(cell.transform:Get(string.format("pos_%d", i)))
        cls.pos[i].mask     = cell.transform:Get(string.format("pos_%d/img_mask", i))
        cls.pos[i].border   = cell.transform:Get(string.format("pos_%d/img_border", i))
        cls.pos[i].fsborder = cell.transform:GetImageComponent(string.format("pos_%d/img_fsborder", i))
    end

    cls.txt_title   = cell.transform:GetTextComponent("img_title_bg/txt_title")
    cls.btnImg      = cell.transform:GetImageComponent("button_use")
    cls.btnTxt      = cell.transform:GetTextComponent("button_use/label_title")
    cls.btnTxtex    = cell.transform:GetTextComponent("button_use/label_title_ex")
    cls.btnImg      = cell.transform:GetImageComponent("button_use")
    cls.imgPre      = cell.transform:Get("img_prefect")
    cell.transform:GetButtonComponent("button_use"):AddButtonListener(function()
        -- 一键装备 TODO
        self:onClickUse(cls.row)
    end)
    cls.row = 0
    return cls
end

function EquipSuitLayer:refreshCell(cell, row)
    local cls = self._cellsObj[cell.name]
    if cls == nil then
        cls = self:newCellObj(cell)
        self._cellsObj[cell.name] = cls
    end
    self:refreshCellObj(cls, row)
end

function EquipSuitLayer:refreshCellObj(cls, row)
    local index = row
    local data = self.dataList[index]

    local tags = self:getTags(data)
    local equips = self:getShowEquips(index)
    local lightShow = self:getLightShow(#data, equips)

    for i = 1, 3 do
        local showTxt = i <= #data
        cls.txtHave[i].obj:SetVisible(showTxt)
        if showTxt then
            local suidData = Equip:GetSuitTag(data[i].cfgid)
            cls.txtHave[i].txt:SetText(string.format("%d%s", data[i].num, suidData))
        end

        local showTag = i <= #tags
        cls.tags[i].obj:SetVisible(showTag)
        if showTag then
            Equip:SetEquipTag(data[i].cfgid, cls.tags[i].img, cls.tags[i].txt)
        end

        local showLight = lightShow[i]
        cls.txtHave[i].txt.color = showLight and COLOR_TYPE.EquipSuitOn or COLOR_TYPE.EquipSuitOff
        cls.imgLight[i]:SetVisible(showLight)

    end

    local uidNum = 0;
    for i = 1, 6 do
        cls.pos[i].mask:SetVisible(not equips[i].uid)
        local scale = 1
        local _qlty = Bag.QLTY_N
        if equips[i].uid then
            uidNum = uidNum + 1
            -- 拥有装备
            Equip:SetEquipCObjByUid(cls.pos[i].cobj, equips[i].uid)
            local qlty = Equip:GetEquip(equips[i].uid).qlty
            _qlty = qlty
            if qlty == Bag.QLTY_SSR or qlty == Bag.QLTY_SR or qlty == Bag.QLTY_UTR then
                scale = 0.38
            end
        elseif equips[i].id then
            -- 未拥有装备
            Equip:SetEquipCObjByCfgid(cls.pos[i].cobj, equips[i].id)
        end
        cls.pos[i].border:SetScale(scale, scale, scale)

        local txtTbl = {"N", "R", "SR", "SSR", "W"}
        local _filepath =   "source_icon/equip/" .. txtTbl[_qlty]..i
        cls.pos[i].fsborder.sprite = AssetLoader:LoadSprite(_filepath)
    end

    cls.txt_title.text = LanguageMgr:GetTextByID(tostring(73001012 + tonumber(data.quality)))
    local isShow = self:getPrefectShow(lightShow)
    cls.imgPre:SetVisible(uidNum >= 6)
    cls.btnImg.sprite  = AtlasMgr:LoadAtlasSprite("source_atlas/atlas_common_res", isShow and "comm_btn_3" or "Common_Btn_Kuan_1");
    cls.btnTxt.color   = isShow and COLOR_TYPE.Black or COLOR_TYPE.White
    cls.btnTxtex.color = isShow and COLOR_TYPE.Black or COLOR_TYPE.White
    cls.row = row
end

function EquipSuitLayer:getTags(data)

    local res = {}
    for k, v in ipairs(data) do
        local db = Equip:GetEquipSuitCfg(v.cfgid)
        local t = {}
        t.signimg = db.signimg
        t.sign = db.sign
        table.insert(res, t)
    end

    if #res == 3 then
        if res[3].sign == res[2].sign or res[2].sign == res[1].sign then
            res[3].sign = nil   -- TODO
        end
    end
    if res[2].sign == res[1].sign then
        res[2].sign = nil   -- TODO
    end

    return res
end

function EquipSuitLayer:getShowEquips(index)
    local hero = Hero:GetHero(self._heorid)
    local equips = {}
    for i = 1, 6 do
        local suitid = self:getSuitID(i, index)
        local uid = Equip:GetEquipsUIDByTypeSuit(i, suitid, self._heorid)
        if uid then
            equips[i] = {uid = uid}
        else
            local id = Equip:GetEquipsIDByTypeSuit(i, suitid)
            equips[i] = {id = id}
        end
    end
    return equips
end

function EquipSuitLayer:onClickUse(index)

    local hero = Hero:GetHero(self._heorid)
    local haveEquip = false
    local equips = {}
    local showEquips = self:getShowEquips(index)
    local haveHigh = false -- 高等级装备
    for i = 1, 6 do
        local suitid = self:getSuitID(i, index)
        local uid = Equip:GetEquipsUIDByTypeSuit(i, suitid, self._heorid)
        if uid then
            local have = false -- 是否已装备
            for k, v in pairs(hero.equipids) do
                if v == uid then
                    haveEquip = true
                    have = true
                    break
                end
            end
            if not have then
                table.insert(equips, uid)
            end
            if hero.equipids[i] ~= 0 and hero.equipids[i] ~= uid and Equip:GetEquip(hero.equipids[i]).level >= 10 then
                haveHigh = true
            end
        end
    end

    if((equips == {}) or (#equips == 0))then
        if haveEquip then
            UIMgr:ShowTipsLayer(LanguageMgr:GetTextByID(80021)) -- 已装备
        else
            UIMgr:ShowTipsLayer(LanguageMgr:GetTextByID(72000079)) -- 暂无更适合的装备
        end
        return;
    end

    -- 大于10级弹提示: 您将卸载高等级符石, 是否继续?
    if haveHigh then
        UIMgr:ShowMsgBy2CallLayer(LanguageMgr:GetTextByID(73001008), function()
        end, function ()
            self:sendOnDressReq(equips)
        end);
        return
    end

    self:sendOnDressReq(equips)
end

function EquipSuitLayer:sendOnDressReq(equips)
    self.ondress = true
    Equip:OndressReq(self._heorid, equips, true);
end

function EquipSuitLayer:getSuitID(pos, index)
    local data = self.dataList[index]
    local cfgid = data[math.ceil(pos / 4)].cfgid
    if #data == 2 then
        cfgid = data[math.ceil(pos / 4)].cfgid
    elseif #data == 3 then
        cfgid = data[math.ceil(pos / 2)].cfgid
    end
    return Equip:GetEquipSuitCfg(cfgid).suitid
end

function EquipSuitLayer:getLightShow(len, equips)
    local show = {true, true, len == 3}

    for i = 1, 6 do
        if not equips[i].uid then
            if len == 2 then
                show[math.ceil(i / 4)] = false
            elseif len == 3 then
                show[math.ceil(i / 2)] = false
            end
        end
    end
    return show
end

function EquipSuitLayer:getPrefectShow(shows)
    for k, v in pairs(shows) do
        if not v then
            return false
        end
    end
    return true
end

function EquipSuitLayer:onExit()
    self.menu:ShowEquipCircleLayer();
    self.dataList       = nil
    self._cellsObj      = nil
    self._heorid        = nil
    self.tvController:Clear()
    self.tvController  = nil
    self.ondress        = nil
    self.menu = nil;
    CBaseLayer.onExit(self)
end

return EquipSuitLayer

