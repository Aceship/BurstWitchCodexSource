---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Administrator.
--- DateTime: 2019/9/6 11:44
---
local CBaseLayer = core.require("xlua/lua_UI/UIBaseLayer.txt")
local ChapterOverLayer = class("ChapterOverLayer", CBaseLayer)
--按钮
local BTNS = {

}
--构造函数
function ChapterOverLayer:ctor(super)
    CBaseLayer.ctor(self)
    self._prefab = {
        path = "prefab_uiHome/ui_fight/UI_ChapterOverLayer",
    }
    self._fading = false;
    self._uitype = 2;
    self:onEnter()
end


--进入Ui调用一次
function ChapterOverLayer:onEnter()
    self:createPnl();
    self:registerButtonEvent(BTNS);    
    self.btnBack = self.layer:GetButtonComponent("button_back")
    self.btnBack.interactable = false;
    self:Init();
end

--按钮事件
function ChapterOverLayer:onButtonClick(itype)

end

--退出按钮事件
function ChapterOverLayer:onBackClick()
    self.btnBack.interactable = false;
    self:playAni("ChapterOverLayer2Anim");
end

--初始化
function ChapterOverLayer:Init()
    self.txtItems = {};
    self.txtList = self.layer.transform:Find("content/txt_list");
    self.txtItemPrefab = self.layer.transform:Find("content/item_hide/txt_item").gameObject;
end

--显示UI
function ChapterOverLayer:show(chapterid, callback)
    self.chapter = Chapter:GetChapter(chapterid);
    self:showLayer();
    self.callback = callback;
    self:playAni("ChapterOverLayerAnim")
end

--初始化
function ChapterOverLayer:InitUI()
    self.txtStrs = lua_str_split(self.chapter.map_end_des,"&");
    if(self.txtStrs == nil or #self.txtStrs <= 0)then
        if(self.callback)then
            self:callback();
        end
        Groble_SceneMgr:PrefsSetString("isNewOverChapter"..tostring(self.chapter.nindex)..Player:GetId(),"1")
        return;
    end
    for i, v in ipairs(self.txtStrs) do
        if(self.txtItems[i] == nil)then
            self.txtItems[i] = {};
            self.txtItems[i].parentRect = CS.UnityEngine.GameObject.Instantiate(self.txtItemPrefab, self.txtList):GetComponent("RectTransform");
            self.txtItems[i].txt = self.txtItems[i].parentRect.transform:Find("txt"):GetComponent("Text");
        end
        self.txtItems[i].txt.color = CS.UnityEngine.Color(1,1,1,0);
        self.txtItems[i].txt.text = v;
        self.txtItems[i].parentRect.anchoredPosition = CS.UnityEngine.Vector2(self.txtItems[i].txt.preferredWidth,self.txtItems[i].txt.preferredHeight);
        self.txtItems[i].txt.transform.localPosition = CS.UnityEngine.Vector3(self.txtItems[i].txt.transform.localPosition.x,- 15,self.txtItems[i].txt.transform.localPosition.z);
        local dt = self.txtItems[i].txt:DOColor(CS.UnityEngine.Color(1,1,1,1),0.6):SetEase(CS.DG.Tweening.Ease.Linear):SetDelay(i * 0.6);
        self.txtItems[i].txt.transform:DOLocalMove(CS.UnityEngine.Vector3.zero,0.6):SetEase(CS.DG.Tweening.Ease.Linear):SetDelay(i * 0.6);
        if(i == #self.txtStrs)then
            dt:OnComplete(function ()
                self:aniEnd()
            end);
        end
    end
end

function ChapterOverLayer:aniEnd()
    if Chapter:IsAutoFight() then
        self:onBackClick()
    else
        self.btnBack.interactable = true;
    end
end

function ChapterOverLayer:KeyFrameCall(index)
    if(index == 1)then
        self:InitUI();
    elseif(index == 2)then
        if(self.callback)then
            self:callback();
        end
        Groble_SceneMgr:PrefsSetString("isNewOverChapter"..tostring(self.chapter.nindex)..Player:GetId(),"1")
        self:onPopLayer();
    end
end

return ChapterOverLayer;
