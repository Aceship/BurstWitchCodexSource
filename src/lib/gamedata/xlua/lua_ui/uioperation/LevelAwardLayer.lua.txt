
---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Administrator.
--- DateTime: 2019/10/8 11:33
--- 升级礼包

local CBaseLayer = core.require("xlua/lua_UI/UIBaseLayer.txt")
local LevelAwardLayer = class("LevelAwardLayer", CBaseLayer)
--构造函数
function LevelAwardLayer:ctor(super, parent)
    CBaseLayer.ctor(self)
    self._prefab = {
        path = "prefab_uiOperation/UI_LevelAwardLayer",
        trans = parent,
        obj = true
    }
    self._fading = false;
    self:onEnter();
end


--进入Ui调用一次
function LevelAwardLayer:onEnter()
    self:createPnl();
    self:RegisterHandler();
    self:Init();
end

--初始化
function LevelAwardLayer:Init()
    self.allData = Operation:GetChargeIdsByUID(Activity:GetCurSelectUid(),true);
    self.curIndex = 1;
    self.items = {};
    self.boughtBags = {};
    self.packageItems = {};
    self.MGroup = self.layer:Get("package_info/MGroup"):GetComponent("MGroup");
    self.buyItemPrefab = self.layer:Get("item_hide/buy_item").gameObject;

    self.leftBtn = self.layer:GetButtonComponent("package_info/left_btn");
    self.rightBtn = self.layer:GetButtonComponent("package_info/right_btn");


    self.lvScantyTxt = self.layer:GetTextComponent("package_info/lv_scanty_txt");

    self.leftBtnImg = self.layer:GetImageComponent("package_info/left_btn/icon");
    self.rightBtnImg = self.layer:GetImageComponent("package_info/right_btn/icon");

    self.MGroup.SelectAction = function ()
        self:CutPackage()
    end ;
    self.boughtBags = Operation:GetBoughtBags();
    self.curIndex = Operation:GetValidUpgradePackageIndex(Activity:GetCurSelectUid());
    local initIndex = self.curIndex - 1;
    self.MGroup:Init(#self.allData,initIndex);
    for i, v in ipairs(self.allData) do
        if(self.packageItems[i] == nil)then
            self.packageItems[i] = {};
            self.packageItems[i].imgBg = self.MGroup.transform:GetImageComponent(i);
            self.packageItems[i].imgRBBg = self.MGroup.transform:GetImageComponent(i.."/img_r_bg");
            self.packageItems[i].pagTitleTxt = self.MGroup.transform:GetTextComponent(i.."/title_txt");
            self.packageItems[i].pagTitleTxt_E = self.packageItems[i].pagTitleTxt.transform:GetTextComponent("title_txt_E");
            self.packageItems[i].yetBuyImg = self.MGroup.transform:Get(i.."/yet_buy_img");
            self.packageItems[i].txtLv = self.MGroup.transform:GetTextComponent(i.."/txt_lv");
            self.packageItems[i].imgLock = self.MGroup.transform:GetImageComponent(i.."/img_lock");
            self.packageItems[i].btnGet = self.MGroup.transform:GetButtonComponent(i.."/btn_get");
            self.packageItems[i].btnGet.onClick:AddListener(function ()
                self:OnBuyBtnClick(self.packageItems[i].chargeId);
            end);
            self.packageItems[i].items = {};
            if(self.boughtBags[v] == nil)then
                self.packageItems[i].yetBuyImg:SetVisible(false);
            else
                self.packageItems[i].yetBuyImg:SetVisible(true);
            end
        end
    end

end

--显示UI
function LevelAwardLayer:show()
    self:showLayer();
    self:InitUI();
end

function LevelAwardLayer:showLayer()
    CBaseLayer.showLayer(self);
    self.layer:SetPositionY(0,true);
end

function LevelAwardLayer:hideLayer()
    CBaseLayer.hideLayer(self);
    self.layer:SetPositionY(5000,true);
end

--初始化UI
function LevelAwardLayer:InitUI()
    local charge;
    for i, v in ipairs(self.allData) do
        charge = Recharge:GetData(v);
        self.packageItems[i].chargeId = v;
        for l, j in ipairs(charge.goods) do
            if(self.packageItems[i].items[l] == nil)then
                local trans = CS.UnityEngine.GameObject.Instantiate(self.buyItemPrefab ,self.layer:Get("package_info/MGroup/"..i.."/content"));
                local cls = Bag:CtorComSimpleGoodsUi(trans)
                self.packageItems[i].items[l] = cls;
            end
            self.packageItems[i].items[l]:Visible(true);
            Bag:SetComSimpleGoodsUi(self.packageItems[i].items[l],j[1], j[2],j[3], true);
            self.packageItems[i].items[l].transform.localScale = CS.UnityEngine.Vector3(0,0,1);
            self.packageItems[i].items[l].transform:DOScale(0.6, 0.1):SetDelay(0.03 * l);
        end
        if(#self.packageItems[i].items > #charge.goods)then
            for j = #charge.goods + 1, #self.items do
                self.packageItems[i].items[j]:Visible(false);
            end
        end
        local showLock = Player:GetLevel() < charge.openData[1][2];
        self.packageItems[i].btnGet:SetVisible(self.boughtBags[v] == nil and not showLock);
        if(self.boughtBags[v] == nil and not showLock)then--可领取
            self.packageItems[i].imgBg:LoadAtlasSprite(AtlasMgr.Activity,"Img_sjfl_diban");
            self.packageItems[i].txtLv:SetTextColor(0,0,0,1);
            self.packageItems[i].pagTitleTxt:SetTextColor(0,0,0,1);
            self.packageItems[i].pagTitleTxt_E:SetTextColor(30/255,30/255,30/255,1);
            self.packageItems[i].imgRBBg:SetImageColor(1,1,1,1);
        else
            self.packageItems[i].imgBg:LoadAtlasSprite(AtlasMgr.Activity,"Img_sjfl_dihei");
            self.packageItems[i].txtLv:SetTextColor(1,1,1,1);
            self.packageItems[i].pagTitleTxt:SetTextColor(1,1,1,1);
            self.packageItems[i].pagTitleTxt_E:SetTextColor(144/255,144/255,144/255,1);
            self.packageItems[i].imgRBBg:SetImageColor(0,0,0,150/255);
        end
        self.packageItems[i].imgLock:SetEnabled(showLock);
        self.packageItems[i].pagTitleTxt.text = charge.name;
        self.packageItems[i].pagTitleTxt_E.text = charge.name_E;
        self.packageItems[i].txtLv:SetText(string.format(LanguageMgr:GetTextByID(90365),math.min(Player:GetLevel(),charge.openData[1][2]),charge.openData[1][2]))
    end
end

--切换礼包事件
function LevelAwardLayer:CutPackage()
    self.curIndex = self.MGroup.m_CurrentSelectIndex + 1;
    if(self.curIndex == 1)then
        if(self.leftBtnImg.enabled)then
            self.leftBtnImg.enabled = false;
            self.leftBtn.interactable = false;
        end
        if(not self.rightBtnImg.enabled)then
            self.rightBtnImg.enabled = true;
            self.rightBtn.interactable = true;
        end
    elseif(self.curIndex == #self.allData)then
        if(not self.leftBtnImg.enabled)then
            self.leftBtnImg.enabled = true;
            self.leftBtn.interactable = true;
        end
        if(self.rightBtnImg.enabled)then
            self.rightBtnImg.enabled = false;
            self.rightBtn.interactable = false;
        end
    else
        if(not self.leftBtnImg.enabled)then
            self.leftBtnImg.enabled = true;
            self.leftBtn.interactable = true;
        end
        if(not self.rightBtnImg.enabled)then
            self.rightBtnImg.enabled = true;
            self.rightBtn.interactable = true;
        end
    end

    local useData = Recharge:GetData(self.allData[self.curIndex]);
    if(self.boughtBags[useData.cfgid] == nil)then
        local onBuy = Player:GetLevel() >= useData.openData[1][2];
        self.lvScantyTxt:SetEnabled(not onBuy);
        if(onBuy)then
            if(useData.discount < 1)then
                self._txtDiscount:SetText(string.format(LanguageMgr:GetTextByID(90366), tostring((useData.discount * 10))));
            end
        else
            self.lvScantyTxt.text = string.format(LanguageMgr:GetTextByID(90071), useData.openData[1][2]);
        end
    else
        self.lvScantyTxt:SetEnabled(true);
        self.lvScantyTxt:SetText(LanguageMgr:GetTextByID(90069));
    end
end

function LevelAwardLayer:OnBuyBtnClick(chargeId)
    Recharge:SetCurSelectGiftPagId(chargeId);
    Operation:SendMessage(Operation:GetCurSelectUID(),{id = chargeId, num = 1})
end


--注册
function LevelAwardLayer:RegisterHandler()
    self:addEventListener(EVENT_NAME.BUY_UPGRADE_PACKAGE_REP,self.__cname,function(drops)
        Bag:ShowDrops(drops,function()
            self.boughtBags = Operation:GetBoughtBags();
            if(self.packageItems[self.curIndex] ~= nil)then
                self.packageItems[self.curIndex].yetBuyImg:SetVisible(self.boughtBags[self.allData[self.curIndex]] ~= nil);
            end
            self.curIndex = Operation:GetValidUpgradePackageIndex(Activity:GetCurSelectUid());
            self:show();
            self.MGroup:ChangeToIndex(self.curIndex - 1);--C#数组下标从0开始,故要减一
            self:CutPackage();
        end)
    end);
end


function LevelAwardLayer:onBackClick()
    self:onPopLayer();
end

return LevelAwardLayer;