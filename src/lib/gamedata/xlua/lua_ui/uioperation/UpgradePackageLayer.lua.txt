
---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Administrator.
--- DateTime: 2019/10/8 11:33
--- 升级礼包

local CBaseLayer = core.require("xlua/lua_UI/UIBaseLayer.txt")
local UpgradePackageLayer = class("UpgradePackageLayer", CBaseLayer)
--构造函数
function UpgradePackageLayer:ctor(super,parent)
    CBaseLayer.ctor(self)
    self._prefab = {
        path = "prefab_uiOperation/UI_UpgradePackageLayer",
        trans = parent,
        obj = true
    }
    self._fading = false;
    self:onEnter();
end


--进入Ui调用一次
function UpgradePackageLayer:onEnter()
    self:createPnl();
    self:RegisterHandler();
    self:Init();
    Activity:SetEnterUpgradePackageLayer()
    GEvent:fireEvent(EVENT_NAME.UPDATE_OPER_TOG_STATE)
end

--初始化
function UpgradePackageLayer:Init()
    self.allData = Recharge:GetAllDataByType(Recharge.ChargeType.UpgradePackage);
    self.curIndex = 1;
    self.items = {};
    self.boughtBags = {};
    self.packageItems = {};
    self.MGroup = self.layer:Get("package_info/MGroup"):GetComponent("MGroup");
    self.buyItemPrefab = self.layer:Get("item_hide/buy_item").gameObject;

    self.buyBtn = self.layer:GetButtonComponent("package_info/buy_btn");
    self.leftBtn = self.layer:GetButtonComponent("package_info/left_btn");
    self.rightBtn = self.layer:GetButtonComponent("package_info/right_btn");

    self._transDiscountBg = self.buyBtn.transform:Get("img_discount_bg");

    self.rmgTxt = self.buyBtn.transform:GetTextComponent("rmb_txt");
    self.lvScantyTxt = self.layer:GetTextComponent("package_info/lv_scanty_txt");
    self.yetBuyTxt = self.layer:GetTextComponent("package_info/yet_buy_txt");
    self._txtDiscount = self.buyBtn.transform:GetTextComponent("img_discount_bg/txt_discount");
    self._txtBuyTitle = self.buyBtn.transform:GetTextComponent("txt_buy_title");

    self.imgRmbIcon = self.rmgTxt.transform:GetImageComponent("img_icon");
    self.leftBtnImg = self.layer:GetImageComponent("package_info/left_btn/icon");
    self.rightBtnImg = self.layer:GetImageComponent("package_info/right_btn/icon");

    self.buyBtn.onClick:AddListener(function ()
        self:OnBuyBtnClick();
    end);

    self.MGroup.SelectAction = function ()
        self:CutPackage()
    end ;
    self.boughtBags = Operation:GetBoughtBags();
    self.curIndex = Operation:GetValidUpgradePackageIndex();
    local initIndex = self.curIndex - 1;
    self.MGroup:Init(#self.allData,initIndex);
    for i, v in ipairs(self.allData) do
        if(self.packageItems[i] == nil)then
            self.packageItems[i] = {};
            self.packageItems[i].pagTitleTxt = self.MGroup.transform:GetTextComponent(i.."/title_txt");
            self.packageItems[i].pagTitleTxt_E = self.packageItems[i].pagTitleTxt.transform:GetTextComponent("title_txt_E");
            self.packageItems[i].yetBuyImg = self.MGroup.transform:Get(i.."/yet_buy_img");
            self.packageItems[i].txtLv = self.MGroup.transform:GetTextComponent(i.."/txt_lv");
            self.packageItems[i].imgLock = self.MGroup.transform:GetImageComponent(i.."/img_lock");
            self.packageItems[i].items = {};
            if(self.boughtBags[v.cfgid] == nil)then
                self.packageItems[i].yetBuyImg:SetVisible(false);
            else
                self.packageItems[i].yetBuyImg:SetVisible(true);
            end
        end
    end

end

--显示UI
function UpgradePackageLayer:show()
    self:showLayer();
    self:InitUI();
end

function UpgradePackageLayer:showLayer()
    CBaseLayer.showLayer(self);
    self.layer:SetPositionY(0,true);
end

function UpgradePackageLayer:hideLayer()
    CBaseLayer.hideLayer(self);
    self.layer:SetPositionY(5000,true);
end

--初始化UI
function UpgradePackageLayer:InitUI()
    if(Operation.isSetUpLvRed)then
        Operation:SetIsSetUpLvRed(false);
        GEvent:fireEvent(EVENT_NAME.UPDATE_OPER_TOG_STATE);
    end
    for i, v in ipairs(self.allData) do
        for l, j in ipairs(v.goods) do
            if(self.packageItems[i].items[l] == nil)then
                local trans = CS.UnityEngine.GameObject.Instantiate(self.buyItemPrefab ,self.layer:Get("package_info/MGroup/"..i.."/content"));
                local cls = Bag:CtorComSimpleGoodsUi(trans)
                self.packageItems[i].items[l] = cls;
            end
            self.packageItems[i].items[l]:Visible(true);
            Bag:SetComSimpleGoodsUi(self.packageItems[i].items[l],j[1], j[2],j[3], true);
            self.packageItems[i].items[l].transform.localScale = CS.UnityEngine.Vector3(0,0,1);
            self.packageItems[i].items[l].transform:DOScale(0.6, 0.1):SetDelay(0.03 * l);
        end
        if(#self.packageItems[i].items > #v.goods)then
            for j = #v.goods + 1, #self.items do
                self.packageItems[i].items[j]:Visible(false);
            end
        end
        local showLock = Player:GetLevel() < v.openData[1][2];
        self.packageItems[i].imgLock:SetEnabled(showLock);
        self.packageItems[i].pagTitleTxt.text = v.name;
        self.packageItems[i].pagTitleTxt_E.text = v.name_E;
        self.packageItems[i].txtLv:SetText(string.format(LanguageMgr:GetTextByID(90365),math.min(Player:GetLevel(),v.openData[1][2]),v.openData[1][2]))
    end
end

--切换礼包事件
function UpgradePackageLayer:CutPackage()
    self.curIndex = self.MGroup.m_CurrentSelectIndex + 1;
    if(self.curIndex == 1)then
        if(self.leftBtnImg.enabled)then
            self.leftBtnImg.enabled = false;
            self.leftBtn.interactable = false;
        end
        if(not self.rightBtnImg.enabled)then
            self.rightBtnImg.enabled = true;
            self.rightBtn.interactable = true;
        end
    elseif(self.curIndex == #self.allData)then
        if(not self.leftBtnImg.enabled)then
            self.leftBtnImg.enabled = true;
            self.leftBtn.interactable = true;
        end
        if(self.rightBtnImg.enabled)then
            self.rightBtnImg.enabled = false;
            self.rightBtn.interactable = false;
        end
    else
        if(not self.leftBtnImg.enabled)then
            self.leftBtnImg.enabled = true;
            self.leftBtn.interactable = true;
        end
        if(not self.rightBtnImg.enabled)then
            self.rightBtnImg.enabled = true;
            self.rightBtn.interactable = true;
        end
    end

    local useData = self.allData[self.curIndex];
    self.buyBtn.transform:SetVisible(self.boughtBags[useData.cfgid] == nil);
    self.yetBuyTxt:SetEnabled(self.boughtBags[useData.cfgid] ~= nil);
    if(self.boughtBags[useData.cfgid] == nil)then
        local onBuy = Player:GetLevel() >= useData.openData[1][2];
        self.lvScantyTxt:SetEnabled(not onBuy);
        self._transDiscountBg:SetVisible(useData.discount < 1 and onBuy);
        self.buyBtn.interactable = onBuy;
        self.rmgTxt:SetText(tostring(math.ceil(useData.price * useData.discount)));
        self.imgRmbIcon.sprite = Item:LoadSprite(useData.priceId);
        if(onBuy)then
            if(useData.discount < 1)then
                self._txtDiscount:SetText(string.format(LanguageMgr:GetTextByID(90366), tostring((useData.discount * 10))));
            end
            self._txtBuyTitle:SetTextById(90013);
        else
            self.lvScantyTxt.text = string.format(LanguageMgr:GetTextByID(90071), useData.openData[1][2]);
            self._txtBuyTitle:SetTextById(31112);
        end
        if(self.packageItems[self.curIndex] ~= nil)then
            self.packageItems[self.curIndex].yetBuyImg:SetVisible(false);
        end
    else
        self._transDiscountBg:SetVisible(false);
        self.lvScantyTxt:SetEnabled(false);
        if(self.packageItems[self.curIndex] ~= nil)then
            self.packageItems[self.curIndex].yetBuyImg:SetVisible(true);
        end
    end
end

function UpgradePackageLayer:OnBuyBtnClick()
    Recharge:SetCurSelectGiftPagId(self.allData[self.curIndex].cfgid);
    Recharge:OpenBuyTipsLayer();
end

function UpgradePackageLayer:hide()
    self:hideLayer();
    --print("隐藏UI","UpgradePackageLayer");
end


--注册
function UpgradePackageLayer:RegisterHandler()
    self:addEventListener(EVENT_TYPE.SCRIPT_ACTION,EVENT_NAME.BUY_UPGRADE_PACKAGE_REP,function(drops)
        Bag:ShowDrops(drops,function()
            self.boughtBags = Operation:GetBoughtBags();
            self.curIndex = Operation:GetValidUpgradePackageIndex();
            self:show();
            self.MGroup:ChangeToIndex(self.curIndex - 1);--C#数组下标从0开始,故要减一
            self:CutPackage();
        end)
    end);
end


function UpgradePackageLayer:onBackClick()
    self:onPopLayer();
end

return UpgradePackageLayer;