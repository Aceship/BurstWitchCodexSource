---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Administrator.
--- DateTime: 2019/9/19 14:29
---

local CBaseLayer = core.require("xlua/lua_UI/UIBaseLayer.txt")
local ValueSummonLayer = class("ValueSummonLayer", CBaseLayer)
--按钮
local BTNS = {

}
--构造函数
function ValueSummonLayer:ctor(super,parent)
    CBaseLayer.ctor(self)
    self._prefab = {
        path = "prefab_uiOperation/UI_ValueSummonLayer",
        trans = parent,
        obj = true
    }
    self._fading = false;
    self:onEnter()
end

--进入Ui调用一次
function ValueSummonLayer:onEnter()
    self:createPnl();
    self:RegisterHandler();
    self:registerButtonEvent();
    self:Init();
end

--按钮事件注册
function ValueSummonLayer:registerButtonEvent()
    for itype, tbl in pairs(BTNS) do
        self.layer.transform:Find(tbl):GetComponent("Button").onClick:AddListener(coroutine_call(
        function()
            self:onButtonClick(tbl)
        end))
    end
end

--初始化
function ValueSummonLayer:Init()
    self.m_items = {};
    self.itemBg = self.layer.transform:Find("trans_items/item_bg");
    self.itemPrefab = self.layer.transform:Find("item_hide/item").gameObject;
    self.txtTitle = self.layer.transform:Find("txt_title"):GetComponent("Text");
    self.rectTitle = self.txtTitle.transform:GetComponent("RectTransform");
end

--显示UI
function ValueSummonLayer:show()
    -- self.data = Operation:GetActiveChargeCfgByUid(self.uid);
    self.data = Operation:GetActiveCfgByUID(Operation:GetCurSelectUID());
    self:InitUI();
    self:showLayer();
end

function ValueSummonLayer:onBackClick()
    self:onPopLayer();
end

--初始化
function ValueSummonLayer:InitUI()
    -- Operation:SetOperationImage(self.imgBg,self.data.picture);
    self.txtTitle.text = self.data.Name
    local tempV;
    if(self.data.txtWord ~= nil and not lua_table_empty(self.data.txtWord))then
        tempV = CS.UnityEngine.Vector2(tonumber(self.data.txtWord[1]), tonumber(self.data.txtWord[2]));
        self.rectTitle.anchoredPosition = tempV;
        self.rectTitle.localScale = CS.UnityEngine.Vector3(tonumber(self.data.txtWord[3]),tonumber(self.data.txtWord[4]),1)
    end
    for i, v in ipairs(self.data.charges) do
        if(self.m_items[i] == nil)then
            local obj = CS.UnityEngine.GameObject.Instantiate(self.itemPrefab ,self.itemBg);
            self.m_items[i] = core.require("xlua/lua_UI/Controller/GiftBagItem.txt"):new(obj.transform);
            self.m_items[i]:AddListener(function (id)
                self:BuyGiftBag(id);
            end);
        end
        self.m_items[i]:SetData(v,function (trans)
            trans:DOKill();
            trans.localScale = CS.UnityEngine.Vector3(1,0,0);
            local dt = trans:DOScale(1, 0.15):SetDelay(0.1 * i);
        end);
    end
    if(#self.data.charges < #self.m_items)then
        for i = #self.data.charges + 1, #self.m_items do
            self.m_items[i]:HideItem();
        end
    end
end


function ValueSummonLayer:hide()
    self:hideLayer();
end

function ValueSummonLayer:BuyGiftBag(id)
    local data = Recharge:GetData(id)
    if(data.price == 0)then--免费礼包
        Operation:SendMessage(self.uid,{id = id});
        return
    end
    Recharge:SetCurSelectGiftPagId(id);
    Recharge:OpenBuyTipsLayer();
    
end



--注册
function ValueSummonLayer:RegisterHandler()
    self:addEventListener(EVENT_TYPE.UPDATE_GIFT_BAG, self.__cname,function()
        self:InitUI();
    end);
end

return ValueSummonLayer;